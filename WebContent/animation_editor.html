<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>動畫編輯器</title>
<link href="css/jquery-ui.css" rel="stylesheet">
<link href="css/base-ui.css" rel="stylesheet">
<style>
#myCanvas {
	height: 200px;
	width: 400px;
	background-color: black;
	position: absolute; /*絕對位置*/
	top: 18%; /*從上面開始算，下推 50% (一半) 的位置*/
	left: 50%; /*從左邊開始算，右推 50% (一半) 的位置*/
	margin-top: -100px; /*高度的一半*/
	margin-left: -200px; /*寬度的一半*/
}

span {
	margin: 5px;
	font-size: 16px;
}

rect {
	padding: 5px;
}

svg {
	background-color: #ffebcd;
	margin: 5px;
}

#time_svg {
	margin-left: 175px;
	width: 1560px;
	height: 40px;
}

#key_svg {
	width: 160px;
	float: left;
	height: 100px;
}

#value_svg {
	width: 1560px;
	float: left;
	height: 100px;
}

#value_svg rect {
	margin: 2px;
	cursor: pointer;
}


.cell {
	background-color: yellow;
}

.clear {
	clear: both;
}
}
</style>
</head>
<body>

	<div>
		<p>Image to use:</p>
		<img id="scream" src="images\orange.png" alt="The Scream" width="200" height="200">
	</div>

	<canvas id="myCanvas" width="400" height="200" style="border: 3px solid #000000;">
    </canvas>


	<button id="btn_run" style="float: left" class="button-link ui-state-default ui-corner-all">RUN</button>
	<button id="btn_stop" style="float: left" class="button-link ui-state-default ui-corner-all">STOP</button>

	<div style="float: right">
		<h2>Value</h2>
		<input style="margin-right: 100px" id="edit_value">
	</div>
	<div>
		<svg id="time_svg"></svg>
		<div>
			<svg id="key_svg"></svg>
			<svg id="value_svg">
			<rect id="value_convas" x="4" y="4" width="1552" height="92" fill="white" />
			</svg>
		</div>
	</div>
	<div class="clear"></div>
	<div>
		<p>Debug:</p>
		<div id="demod3"></div>
	</div>
	<script src="js/jquery.js"></script>
	<script src="js/jquery-ui.js"></script>
	<script src="js/d3.min.js"></script>
	<script src="js/KeyTable.js"></script>
	<script>
		var canvas = document.getElementById("myCanvas");
		var ch = canvas.height;
		var cw = canvas.width;
		var ctx = canvas.getContext("2d");
		var worker;

		var fw = 1400;//document.getElementById("time_svg").getBBox().width;
		var time = Date.now();
		var maxTime;

		var keyFrame = new KeyTable([ {
			key : "x",
			value : new Array(new Key(0, 0, INT_LINEAR), new Key(3000, 200, INT_LINEAR))
		}, {
			key : "y",
			value : new Array(new Key(0, 0, INT_LINEAR), new Key(1000, 150, INT_LINEAR), new Key(2000, 50, INT_LINEAR), new Key(3000, 150, INT_LINEAR))
		} ]);

		function draw(time) {
			background();
			var applyList = getApplyList(keyFrame, time);
			//console.log(applyList);
			var img = document.getElementById("scream");
			img.src = "images/orange.png"
			ctx.drawImage(img, applyList["x"], applyList["y"]);
			if (time > maxTime) {
				worker.terminate();
			}
		}

		function background() {
			ctx.fillStyle = "#FFFFFF";
			ctx.fillRect(0, 0, cw, ch);
			ctx.moveTo(0, ch / 2);
			ctx.lineTo(cw, ch / 2);
			ctx.stroke();
			ctx.moveTo(cw / 2, 0);
			ctx.lineTo(cw / 2, ch);
			ctx.stroke();
		}

		$("#btn_run").click(function(event) {
			time = Date.now();
			worker = new Worker("js/worker.js");
			worker.onmessage = function(event) {
				draw(Date.now() - time);
			};
		});

		$("#btn_stop").click(function(event) {
			worker.terminate();
		});

		draw(0);

		// D3 的用法和我們一般寫程式的直覺不一樣, 需要花一點時間熟悉
		// D3 入們教學 http://bost.ocks.org/mike/circles/
		// D3 教學 https://www.dashingd3js.com/binding-data-to-dom-elements

		function demo_d3(selector, data) {
			console.log("demo_d3");
			console.log(data);
			$(selector).html("");
			var w1 = d3.selectAll(selector).append("div").attr("class", "container");

			var row = w1.selectAll(".row").data(data).enter().append("div").attr("class", "row");
			//.on('click', function(d) {
			//	console.log(d);
			//})

			row.append("span").attr("class", "title").text(function(d) {
				return d.key;
			})

			row.selectAll("span.cell").data(function(d) {
				return d.value;
			}).enter().append("span").attr("class", "cell").text(function(d) {
				return "(p:" + d.pos.toFixed(0) + ", v:" + d.value + ")";
			})

		}

		// jquery 和 d3 最的不同之處在於
		// jquery 適合(1)處理結構複雜但是(2)資料量小的狀況, 也就是說jquery比較適合處理一般化的狀況
		// d3 適合處理(1)結構簡單但是(2)資料量大或(3)需圖性化整齊的顯示資料或(4)需要運算的狀況
		// d3 也特別適合顯示有座標軸概念的資料

		var xratio;

		function timeLine(selector, data) {
			// 取最大時間點
			var temp = [];
			for ( var i in data) {
				temp[i] = data[i].value[data[i].value.length - 1].pos;
			}
			maxTime = d3.max(temp);

			// 時間軸
			var timeLine = [];
			temp = maxTime / 10;
			timeLine[0] = 0;
			for (i = 1; i < 11; i++) {
				timeLine[i] = timeLine[i - 1] + temp;
			}
			console.log(timeLine);

			xratio = fw / maxTime;
			console.log("xratio " + xratio);

			var text = d3.select(selector).selectAll("text").data(timeLine).enter().append("text").text(function(d) {
				return d;
			}).attr("y", 30).attr("x", function(d, i) {
				return d * xratio + 30;
			}).attr("width", 60).attr("height", 40).attr("fill", "SaddleBrown").attr("font-size", 16).attr("text-anchor", "middle");

		}

		function keyLabel(selector, data) {

			var text = d3.select(selector).selectAll("text").data(data).enter().append("text").text(function(d) {
				return d.key;
			}).attr("y", function(d, i) {
				return i * 40 + 40;
			}).attr("x", 130).attr("width", 60).attr("height", 40).attr("fill", "SaddleBrown").attr("font-size", 22).attr("text-anchor", "right");
		}

		function valueLabel(selector, data) {
			var svg = d3.select(selector);

			var values = data.value;
			for ( var keys in data) {
				var values = data[keys].value;
				console.log("values");
				console.log(values);
				var rect = svg.selectAll("rect." + "key" + keys).data(values).enter().append("rect").attr("class", "key" + keys).attr("y", function(d, i) {
					return keys * 40 + 20;
				}).attr("x", function(d, i) {
					//console.log("x" + i);
					//console.log(d);
					return d.pos * xratio + 30;
				}).attr("width", 10).attr("rx", 2).attr("ry", 2).style("fill", "coral").attr("height", 25);
				rect.on('click', function(d) {
					if (d3.event.defaultPrevented) {
						return;
					}// 為了避免覆蓋掉onDrag的事件
					console.log("clicked!");
					console.log(d);
					showInfo(d);
				}).call(drag);

			}
		}

		var drag = d3.behavior.drag().on('drag', function(d) {
			console.log(d);
			var x = (d.pos * xratio) + d3.event.dx;
			d.pos = x / xratio;
			d3.select(this).attr("x", x);
		}).on('dragend', function(d) {
			// 刷新數據
			console.log("dragend");
			sort(keyFrame.keyMaps);
			demo_d3("#demod3", keyFrame.keyMaps);
		});

		var editer = $("#edit_value");
		var tempData;
		editer.prop('disabled', true);
		editer.focus(function() { // on Focus On
		});
		editer.blur(function() { // on Focus Off
			tempData.value = parseInt(editer.val());
			demo_d3("#demod3", keyFrame.keyMaps);
			editer.prop('disabled', true);
			tempData = null;
		});

		function showInfo(data) {
			console.log("get data");
			console.log(data);
			editer.prop('disabled', false);
			editer.val(data.value);
			tempData = data;
		}

	

		timeLine('#time_svg', keyFrame.keyMaps);
		keyLabel('#key_svg', keyFrame.keyMaps);
		valueLabel('#value_svg', keyFrame.keyMaps);
		demo_d3("#demod3", keyFrame.keyMaps);
	</script>

</body>
</html>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>動畫編輯器</title>
<link
    href="css/jquery-ui.css"
    rel="stylesheet">
<link
    href="css/base-ui.css"
    rel="stylesheet">
<style>
#myCanvas {
    height: 200px;
    width: 400px;
    background-color: black;
    position: absolute; /*絕對位置*/
    top: 18%; /*從上面開始算，下推 50% (一半) 的位置*/
    left: 50%; /*從左邊開始算，右推 50% (一半) 的位置*/
    margin-top: -100px; /*高度的一半*/
    margin-left: -200px; /*寬度的一半*/
}

span {
    margin: 5px;
    font-size: 16px;
}

rect {
    padding: 5px;
}

svg {
    background-color: #f2f2f2;
    margin: 5px;
}

#time_svg {
    margin-left: 175px;
    width: 1560px;
    height: 40px;
}

#key_svg {
    width: 160px;
    float: left;
    height: 100px;
}

#value_svg {
    width: 1560px;
    float: left;
    height: 100px;
}

rect .value_point{
    margin: 2px;
    cursor: pointer;
}

.cell {
    color: #ffa500;
}

.clear {
    clear: both;
}

p{
    color: white;
    font-size: 22px;
}

</style>
</head>
<body>

    <div>
       <p>Image to use:</p>
	   <form action="/file-upload"
	      class="dropzone">
		    <div class="fallback">
	           <input name="file" type="file" multiple />
            </div>
         </form>
     
        <img
            id="scream"
            src="images\orange.png"
            alt="The Scream"
            width="200"
            height="200">
    </div>

    <canvas
        id="myCanvas"
        width="400"
        height="200"
        style="border: 3px solid #000000;">
    </canvas>


    <button
        id="btn_run"
        style="float: left"
        class="button button-link ui-state-default ui-corner-all">RUN</button>
    <button
        id="btn_stop"
        style="float: left"
        class="button button-link ui-state-default ui-corner-all">STOP</button>
    <button
        id="btn_export"
        style="float: left"
        class="button button-link ui-state-default ui-corner-all">EXPORT</button>
    <button
        style="margin-right: 100px; float: right"  
        id="btn_export"
        class="button button-link ui-state-default ui-corner-all">DELECT</button>
    <input style="float: right; margin: 5px"
            id="edit_value">
     
    <p    style="margin-top: -2px; float: right" >Value</p>
    <div>
        <svg id="time_svg"></svg>
        <div>
            <svg id="key_svg"></svg>
            <svg id="value_svg"> </svg>
        </div>
    </div>
    <div class="clear"></div>
    <div>
        <p>Debug:</p>
        <div id="demod3"></div>
    </div>
    <script src="js/dropzone.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/d3.min.js"></script>
    <script src="js/KeyTable.js"></script>
    <script>
    
	    // 允許使用的attr，照理應該不要設限
	    var attrs = ['x', 'y', 'image', 'sound'];
    
        var canvas = document.getElementById("myCanvas");
        var ch = canvas.height;
        var cw = canvas.width;
        var ctx = canvas.getContext("2d");
        var worker;

        var xratio;
        
        var fw = 1400;//document.getElementById("time_svg").getBBox().width;
        var time = Date.now();
        var maxTime;

        var keyFrame = new KeyTable([ 
           new Key('x', 0, 0, INT_LINEAR), 
           new Key('x', 3000, 200, INT_LINEAR),
           new Key('y', 0, 0, INT_LINEAR), 
           new Key('y', 1000, 150, INT_LINEAR), 
           new Key('y', 2000, 50, INT_LINEAR), 
           new Key('y', 3000, 150, INT_LINEAR),
           new Key('image', 0 ,'orange'),
           new Key('image', 1500, 'red')
        ]);
        var keys = keyFrame.keyMaps;

       // var Dropzone = require("dropzone");
        
        function draw(time) {
            // background
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, cw, ch);
            ctx.moveTo(0, ch / 2);
            ctx.lineTo(cw, ch / 2);
            ctx.stroke();
            ctx.moveTo(cw / 2, 0);
            ctx.lineTo(cw / 2, ch);
            ctx.stroke();
            
            // move time_line
            d3.select("#time_line")
            .attr('x1', time*xratio + 30)
            .attr('x2', time*xratio + 30);
            
            var applyList = getApplyList(keyFrame, time);
            // console.log(applyList);
            var img = document.getElementById("scream");
            img.src = "images/orange.png"
            ctx.drawImage(img, applyList["x"], applyList["y"]);
            if (time > maxTime) {
                worker.terminate();
            }
        }


        $("#btn_run").click(function(event) {
            time = Date.now();
            worker = new Worker("js/worker.js");
            worker.onmessage = function(event) {
                draw(Date.now() - time);
            };
            
            // 之後再加進去
           // requestAnimationFrame(function( nowtime) {
           // 	  draw(nowtime - time)
            //	});
        });

        $("#btn_stop").click(function(event) {
            worker.terminate();
        });
        
        $("#btn_export").click(function(event) {
           console.log(JSON.stringify(keyFrame.keyMaps));
        });

        
        function demo_d3(selector, data) {
            console.log("demo_d3");
            console.log(data);
            var w1 = d3.selectAll(selector).html("").append("div").attr("class", "container");

            var row = w1.selectAll(".row")
            .data(data)
            .enter()
            .append("div")
            .attr("class", "row");

            row.append("span")
            .attr("class", "title")
            .text(function(d) {
                return d.key;
            })

            row.selectAll("span.cell")
            .data(function(d) {
                return d.value;
            })
            .enter()
            .append("span")
            .attr("class", "cell")
            .text(function(d) {
                return "(p:" + d.pos.toFixed(0) + ", v:" + d.value + ")";
            })

        }

        
        function setTime(selector, data) {
        	console.log("data");
        	console.log(data);
        	
            // 取最大時間點
            var temp = [];
            for ( var i in data) {
                temp[i] = data[i].value[data[i].value.length - 1].pos;
            }
            console.log(temp);
            maxTime = d3.max(temp);

            // 時間軸
            var timeLine = [];
            temp = maxTime / 10;
            timeLine[0] = 0;
            for (i = 1; i < 11; i++) {
                timeLine[i] = timeLine[i - 1] + temp;
            }
            console.log(timeLine);

            xratio = fw / maxTime;
            console.log("xratio " + xratio);

            var text = d3.select(selector).selectAll("text")
            .data(timeLine)
            .enter()
            .append("text")
            .text(function(d) {
                return d;
            })
            .attr("y", 30)
            .attr("x", function(d, i) {
                return d * xratio + 30;
            })
            .attr("width", 60)
            .attr("height", 40)
            .attr("fill", "#004292")
            .attr("font-size", 16)
            .attr("text-anchor", "middle");
        }

        
        function setLabel(selector, data) {

            var text = d3.select(selector).selectAll("text")
            .data(data)
            .enter()
            .append("text")
            .text(function(d) {
                return d.label;
            })
            .attr("y", function(d, i) {
                return i * 40 + 40;
            })
            .attr("x", 130)
            .attr("width", 60)
            .attr("height", 40)
            .attr("fill", "#004292")
            .attr("font-size", 22)
            .attr("text-anchor", "right");
        }

        
        function setValue(selector, data) {
            var svg = d3.select(selector).html("");
            
            // add key bar
            var canvas = svg.selectAll("rect.value_convas")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "value_convas")
            .attr("x", 20)
            .attr("y", function(d,i){return 15+ 40*i;})
            .attr("width", 1520)
            .attr("height", 35)
            .attr("fill", "white")
            .attr("rx", 2)
            .attr("ry", 2)
            .on("dblclick", function(d, i){
            	  // double click to add new key point
                  var pos= (d3.mouse(this)[0] - 20) / xratio ;
                  setMap(keyFrame, keyFrame.keyMaps.push(new Key(d.label, pos, 0, INT_LINEAR)));
                  refreshValue();
            });
            
            // add key
            var values = data.value;
            for ( var keys in data) {
               var values = data[keys].value;
               var rect = svg.selectAll("rect.value_point." + "key" + keys)
               .data(values)
               .enter()
               .append("rect")
               .attr("class", "value_point key" + keys)
               .attr("y", keys * 40 + 20)
               .attr("x", function(d, i) {
                   //console.log("x" + i);
                   //console.log(d);
                   return d.pos * xratio + 30;
               })
               .attr("rx", 2)
               .attr("ry", 2)
               .style("fill", "#cd0201")
               .attr("height", 25)
               .attr("width", 10);
               
               rect.on('click', function(d) {
                   if (d3.event.defaultPrevented) {
                       return;
                   }// 為了避免覆蓋掉onDrag的事件
                   console.log("clicked!");
                   console.log(d);
                   pointClick(d);
               }).call(drag);
            }
            
            // add time line
            svg.selectAll('line')
            .data([{pos:0}])
            .enter()
            .append('line')
            .attr("id", "time_line")
            .attr("x1", 0)
            .attr("x2",0)
            .attr("y1", 0)
            .attr("y2", 100)
            .attr("stroke","LawnGreen")
            .attr("stroke-width", 4)
            .call(drag);
        }
        

        var drag = d3.behavior.drag().on('drag', function(d) {
        	console.log(d);
            var x = (d.pos * xratio) + d3.event.dx;
            d.pos = x / xratio;
            if(this.tagName.toLowerCase() == 'rect'){
                d3.select(this).attr("x", x);
            }else if(this.tagName.toLowerCase() == 'line'){
            	d3.select(this).attr("x1", x);
            	d3.select(this).attr("x2", x);
            }
        }).on('dragend', function(d) {
            // 刷新數據
            console.log("dragend");
            if(this.tagName.toLowerCase() == 'rect'){
            	 refreshDebug();
            }else if(this.tagName.toLowerCase() == 'line'){
            	draw(d.pos);
            }
        });

        var tempValues;
        var tempData;
        var editer = $("#edit_value");
        {
	        editer.prop('disabled', true);
	        editer.focus(function() { // on Focus On
	        });
	        editer.blur(function() { // on Focus Off
	            tempData.value = parseInt(editer.val());
	            refreshDebug();
	            editer.prop('disabled', true);
	            tempData = null;
	        });
	        var del_btn =  $("#btn_delect");
	        del_btn.prop('disabled', true);
	        $("#btn_delect").click(function(event) {
	        	keyFrame.keyMaps = $.grep(keyFrame.keyMaps, function(value ) {
	        		value.value = $.grep(value.value, function(key ) {
	        			  return key  != tempData;
	        		});
	        		 return true;
	            });
	            tempData = null;
	            refreshValue();
	        });
        }
        
        function pointClick(data){
        	 editer.prop('disabled', false);
        	 del_btn.prop('disabled', false);
             editer.val(data.value);
             tempData = data;
        }
        
        
        function refresh(){
        	 setTime('#time_svg', keyFrame.attrMap);
             setLabel('#key_svg', keyFrame.attrMap);
             setValue('#value_svg', keyFrame.attrMap);
             demo_d3("#demod3", keyFrame.attrMap);
        }
        
        function refreshValue(){
        	setMap(keyFrame, keys);
        	setValue('#value_svg', keyFrame.attrMap);
        	refreshDebug();
        }
        
        function refreshDebug(){
        	demo_d3("#demod3", keyFrame.attrMap);
        }
        
        // turn svg to html
        function makeSVG(tag, attrs) {
            var el= document.createElementNS('http://www.w3.org/2000/svg', tag);
            for (var k in attrs)
                el.setAttribute(k, attrs[k]);
            return el;
        }
        
        refresh();
        draw(0);
        
    </script>

</body>
</html>